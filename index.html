<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Santuario Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame 1.5.0 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Componente para texto 3D con volumen -->
    <script
        src="https://unpkg.com/aframe-text-geometry-component@0.5.2/dist/aframe-text-geometry-component.min.js"></script>

    <!-- Troika Text para A-Frame -->
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>


    <!-- Componentes custom -->
    <script type="module" src="./js/Main.js"></script>
    <script src="./js/controls/desktopControl.js"></script>
    <script src="./js/controls/mobileControl.js"></script>
    <script src="./js/controls/vr-controls.js"></script>
    <script src="./js/controls/fly-mode.js"></script>
    <script src="./js/components/handleClick.js"></script>
    <script src="./js/components/mirrormaterial.js"></script>
    <script src="./js/components/DetectorClickHover.js"></script>
    <script src="./js/components/Embellecedor.js"></script>

    <script>
        AFRAME.registerComponent("vr-scale-rig", {
            schema: {
                vrScale: { type: "number", default: 0.35 }, // factor de escala VR
                playerHeight: { type: "number", default: 1.6 } // altura real jugador
            },

            init: function () {
                const rig = document.querySelector("#rig");
                if (!rig) return;

                this.el.sceneEl.addEventListener("enter-vr", () => {
                    // Aplicar la escala al rig SOLO en VR
                    rig.setAttribute("scale", `${this.data.vrScale} ${this.data.vrScale} ${this.data.vrScale}`);

                    const alturaEscalada = this.data.playerHeight * this.data.vrScale;
                    console.log("游븴 Altura jugador original:", this.data.playerHeight, "m");
                    console.log("游븴 Altura jugador escalada:", alturaEscalada.toFixed(3), "m");
                    console.log("游늺 Escala aplicada al rig:", this.data.vrScale);
                });

                // Opcional: restaurar escala al salir de VR
                this.el.sceneEl.addEventListener("exit-vr", () => {
                    rig.setAttribute("scale", "1 1 1");
                });
            }
        });
    </script>



</head>

<body>
    <a-scene vr-mode-ui="enabled: false" cursor="rayOrigin: mouse" fly-mode>
        <!-- Fondo -->
        <a-sky src="./assets/environment.png" rotation="0 145 0"></a-sky>

        <!-- Luz principal -->
        <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
        <a-entity light="type: ambient; intensity: 0.3"></a-entity>

        <!-- RIG que agrupa movimiento + c치mara -->
        <a-entity id="rig" position="0 0 0" check-player touch-hold
            scroll-fly-smooth="speed:0.02; step:0.25; minY:-10; maxY:10" vr-controls>
            <!-- C치mara con todos tus controles -->
            <a-entity id="camera" camera look-controls arrow-fly-smooth="step:0.005; speed:0.15" swipe-up-down
                swipe-left-right raycaster="objects: [data-raycastable]" clickable position="0 0.25 0">
            </a-entity>

            <!-- WebXR controllers para VR con cursor visible -->
            <a-entity laser-controls="hand: left" tracked-controls="hand: left" raycaster="objects: .interactable">
                <a-entity cursor="fuse: false; rayOrigin: controller"
                    geometry="primitive: ring; radiusInner: 0.003; radiusOuter: 0.006"
                    material="color: white; shader: flat">
                </a-entity>
            </a-entity>

            <a-entity laser-controls="hand: right" tracked-controls="hand: right" raycaster="objects: .interactable">
                <a-entity cursor="fuse: false; rayOrigin: controller"
                    geometry="primitive: ring; radiusInner: 0.003; radiusOuter: 0.006"
                    material="color: white; shader: flat">
                </a-entity>
            </a-entity>

        </a-entity>

        <!-- GLB cargado como escenario est치tico -->
        <a-entity id="escenario" gltf-model="./assets/escenario.glb" mirror-material="target: #escenario" check-door
            vr-scale-rig class="interactable"></a-entity>

        <!-- Indicador moviendo: FlightMode / Wings -->
        <a-entity id="hud-wings" position="0.44 0.98 3.015">
            <a-entity id="hud-wings-text"
                text-geometry="value: OFF; font: url(./assets/fonts/Roboto_Regular.json); size: 0.088; height: 0.03; curveSegments: 12"
                material="color: white; side: double; transparent: true; opacity: 0.5" rotation="0 180 0"
                position="0 0 0.01"
                animation="property: position; to: 0 0.02 0.01; dur: 1500; dir: alternate; loop: true; easing: easeInOutSine">
            </a-entity>
        </a-entity>
        </a-entity>


        <!-- HUD o UI principal, pegada al visor -->
        <a-entity id="hud" hud-overlay="camera: #camera" scale="1 1 1">
            <!-- Plano de depuraci칩n para ver el HUD padre -->
            <a-plane hud-autoscale width="0.15" height="0.1" color="transparent" opacity="0.2" position="0 0 0"
                material="shader: flat; side: double; fog: false; depthTest: false; toneMapped: false;">
            </a-plane>

            <!-- Indicador FlightMode que ser치 bot칩nes YES/NO -->
            <a-entity id="y-n" hud-autoscale hud-child-position-scale position="-0.06 -0.04 0">
                <a-plane src="./assets/Wings-HUD.svg" width="0.02" height="0.01" transparent="true"
                    material="shader: flat; side: double; fog: false; depthTest: false; toneMapped: false;">
                </a-plane>

                <a-text id="y-n-text" value="YES" color="white" align="center" width="0.09">
                </a-text>
            </a-entity>
            <!-- Aqu칤 se podr치n a침adir otros indicadores del HUD -->
        </a-entity>

    </a-scene>
</body>

</html>