<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Santuario Digital</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame 1.5.0 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Componente para texto 3D con volumen -->
    <script
        src="https://unpkg.com/aframe-text-geometry-component@0.5.2/dist/aframe-text-geometry-component.min.js"></script>

    <!-- Troika Text para A-Frame -->
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>


    <!-- Componentes custom -->
    <script type="module" src="./js/Main.js"></script>
    <script src="./js/controls/desktopControl.js"></script>
    <script src="./js/controls/mobileControl.js"></script>
    <script src="./js/controls/vr-controls.js"></script>
    <script src="./js/controls/fly-mode.js"></script>
    <script src="./js/components/handleClick.js"></script>
    <script src="./js/components/mirrormaterial.js"></script>
    <script src="./js/components/DetectorClickHover.js"></script>
    <script src="./js/components/Embellecedor.js"></script>
    <script src="./js/components/autoRaycastTag.js"></script>
    <script src="./js/debug-overlay.js"></script>

    <script>
        AFRAME.registerComponent("vr-scale-rig", {
            schema: {
                vrScale: { type: "number", default: 0.25 }, // factor de escala VR
                playerHeight: { type: "number", default: 1.6 } // altura real jugador
            },

            init: function () {
                const rig = document.querySelector("#rig");
                if (!rig) return;

                this.el.sceneEl.addEventListener("enter-vr", () => {
                    // Aplicar la escala al rig SOLO en VR
                    rig.setAttribute("scale", `${this.data.vrScale} ${this.data.vrScale} ${this.data.vrScale}`);

                    const alturaEscalada = this.data.playerHeight * this.data.vrScale;
                    console.log("游븴 Altura jugador original:", this.data.playerHeight, "m");
                    console.log("游븴 Altura jugador escalada:", alturaEscalada.toFixed(3), "m");
                    console.log("游늺 Escala aplicada al rig:", this.data.vrScale);
                });

                // Opcional: restaurar escala al salir de VR
                this.el.sceneEl.addEventListener("exit-vr", () => {
                    rig.setAttribute("scale", "1 1 1");
                });
            }
        });
    </script>



</head>

<body>
    <!-- $$$$$$$$$$$$$ -->
    <!-- DEBUG OVERLAY -->
    <!-- $$$$$$$$$$$$$ -->
    <div id="debug-toggle" style="
            position:fixed;
            top:10px;
            right:10px;
            z-index:999999;
            background:#111;
            color:#0f0;
            padding:8px 12px;
            border-radius:6px;
            font-size:14px;
            cursor:pointer;
            opacity:0.8;">
        Debug
    </div>
    
    <div id="debug-console" style="
            display:none;
            position:fixed;
            top:0;
            right:0;
            width:50%;
            height:100%;
            overflow-y:auto;
            background:#000;
            font-family:monospace;
            font-size:12px;
            padding:12px;
            z-index:999998;
            opacity:0.85;
            border-left:2px solid #0f0;">
    
        <!-- 츼rea de logs -->
        <div id="debug-log"></div>
    
        <!-- L칤nea de comandos -->
        <input id="debug-input" type="text" placeholder="Escribe un comando JS y pulsa Enter" style="
                width:100%;
                margin-top:10px;
                background:#111;
                color:#0f0;
                border:1px solid #0f0;
                padding:6px;
                font-family:monospace;
                font-size:12px;">
    </div>



    <!-- $$$$$$$$$$$$$ -->
    <!--  EL PROYECTO  -->
    <!-- $$$$$$$$$$$$$ -->
    <a-scene webxr="optionalFeatures: local-floor, bounded-floor, hand-tracking, layers" vr-mode-ui="enabled: true"
        cursor="rayOrigin: mouse" fly-mode test-joystick>
        <!-- Fondo -->
        <a-sky src="./assets/environment.png" rotation="0 145 0"></a-sky>

        <!-- Luz principal -->
        <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>
        <a-entity light="type: ambient; intensity: 0.3"></a-entity>

        <!-- RIG que agrupa movimiento + c치mara -->
        <a-entity id="rig" vr-scale-rig position="0 0 0" check-player touch-hold
            scroll-fly-smooth="speed:0.02; step:0.25; minY:-10; maxY:10">
        
            <!-- C치mara con todos tus controles -->
            <a-entity id="camera" camera look-controls arrow-fly-smooth="step:0.005; speed:0.15" swipe-up-down swipe-left-right
                clickable position="0 0.25 0">
            </a-entity>
        
            <!-- CONTROLADOR IZQUIERDO -->
            <a-entity id="controller-left" role="vr-controller" laser-controls="hand: left"
                raycaster="objects: .interactable; far: 30">
        
                <!-- Cursor visible -->
                <a-entity class="controller-cursor" cursor="fuse: false; rayOrigin: controller"
                    geometry="primitive: ring; radiusInner: 0.003; radiusOuter: 0.006" material="color: white; shader: flat">
                </a-entity>
            </a-entity>
        
            <!-- CONTROLADOR DERECHO -->
            <a-entity id="controller-right" role="vr-controller" laser-controls="hand: right"
                raycaster="objects: .interactable; far: 30">
        
                <!-- Cursor visible -->
                <a-entity class="controller-cursor" cursor="fuse: false; rayOrigin: controller"
                    geometry="primitive: ring; radiusInner: 0.003; radiusOuter: 0.006" material="color: white; shader: flat">
                </a-entity>
            </a-entity>
        
        </a-entity>


        <!-- GLB cargado como escenario est치tico -->
        <a-entity id="escenario" gltf-model="./assets/escenario.glb" mirror-material="target: #escenario" check-door
            class="interactable"></a-entity>

        <!-- Indicador moviendo: FlightMode / Wings -->
        <a-entity id="hud-wings" position="0.44 0.98 3.015" auto-raycast-tag>
            <a-entity id="hud-wings-text"
                text-geometry="value: OFF; font: url(./assets/fonts/Roboto_Regular.json); size: 0.088; height: 0.03; curveSegments: 12"
                material="color: white; side: double; transparent: true; opacity: 0.5" rotation="0 180 0"
                position="0 0 0.01"
                animation="property: position; to: 0 0.02 0.01; dur: 1500; dir: alternate; loop: true; easing: easeInOutSine">
            </a-entity>
        </a-entity>


        <!-- HUD o UI principal, pegada al visor -->
        <a-entity id="hud" hud-overlay="camera: #camera" scale="1 1 1">
            <!-- Plano de depuraci칩n para ver el HUD padre -->
            <a-plane hud-autoscale width="0.15" height="0.1" color="transparent" opacity="0.2" position="0 0 0"
                material="shader: flat; side: double; fog: false; depthTest: false; toneMapped: false;">
            </a-plane>

            <!-- Indicador FlightMode que ser치 bot칩nes YES/NO -->
            <a-entity id="y-n" class="interactable" hud-autoscale hud-child-position-scale position="-0.06 -0.04 0">
                <a-plane src="./assets/Wings-HUD.svg" width="0.02" height="0.01" transparent="true"
                    material="shader: flat; side: double; fog: false; depthTest: false; toneMapped: false;">
                </a-plane>

                <a-text id="y-n-text" value="YES" color="white" align="center" width="0.09">
                </a-text>
            </a-entity>
            <!-- Aqu칤 se podr치n a침adir otros indicadores del HUD -->
        </a-entity>

    </a-scene>
</body>

</html>